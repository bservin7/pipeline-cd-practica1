name: CI/CD Simple

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Kind Cluster
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/
        
        kind create cluster --name kind --wait 120s
    
    - name: Build and Load Image
      run: |
        docker build -t ms-ejemplo:latest -f src/Dockerfile src/
        kind load docker-image ms-ejemplo:latest --name kind
    
    - name: Deploy Application
      run: |
        kubectl apply -f k8s/
        sleep 15
        kubectl get all
    
    - name: Test Deployment
      run: |
        timeout 60 bash -c 'until kubectl get pod -l app=ms-ejemplo -o jsonpath="{.items[0].status.phase}" | grep -q Running; do sleep 5; done'
        kubectl port-forward svc/ms-ejemplo 3000:80 &
        sleep 5
        curl -f http://localhost:3000/health && echo "âœ… Health check passed"
        kill %1
