name: CI/CD Pipeline Final

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t ms-ejemplo:latest .
        echo "Image built successfully"
    
    - name: Setup Kubernetes with Kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/
        
        kind create cluster --name kind --wait 120s
        
        kind load docker-image ms-ejemplo:latest --name kind
    
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/postgres.yaml
        sleep 15
        
        kubectl apply -f k8s/deployment-blue.yaml
        kubectl wait --for=condition=available --timeout=300s deployment/ms-ejemplo-blue
        
        kubectl apply -f k8s/deployment-green.yaml
        kubectl scale deployment/ms-ejemplo-green --replicas=1
        
        kubectl get all
    
    - name: Test Deployment
      run: |
        kubectl port-forward svc/ms-ejemplo 8080:80 &
        sleep 20
        
        if curl -f http://localhost:8080/health; then
          echo "SUCCESS: Health check passed"
          echo "Switching to Green deployment"
          kubectl patch service ms-ejemplo -p '{"spec":{"selector":{"version":"green"}}}'
        else
          echo "ERROR: Health check failed"
          echo "Staying with Blue deployment"
          exit 1
        fi
    
    - name: Save Results
      if: always()
      run: |
        kubectl get all -o wide > results.txt
        echo "=== FINAL STATE ==="
        cat results.txt
    
    - name: Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: deployment-results
        path: results.txt
