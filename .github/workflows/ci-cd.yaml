name: CI-CD BlueGreen+Flags

on:
  push:
    branches: [ main ]

jobs:

  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.img.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build docker image
        id: img
        run: |
          IMAGE_NAME=ms-ejemplo:latest
          docker build -t $IMAGE_NAME .
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Save image tar
        run: |
          docker save ms-ejemplo:latest -o image.tar
          mkdir -p artifacts
          mv image.tar artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: image
          path: artifacts/image.tar

  deploy-and-test:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---------------------------
      # DOWNLOAD DOCKER IMAGE
      # ---------------------------
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: image
          path: ./artifacts

      - name: Load Docker image
        run: docker load -i artifacts/image.tar

      # ---------------------------
      # CREATE KIND CLUSTER
      # ---------------------------
      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/

      - name: Create kind cluster
        run: |
          cat > kind-config.yaml <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30001
              hostPort: 30001
              listenAddress: "0.0.0.0"
              protocol: TCP
          EOF
          
          kind create cluster --name kind --config kind-config.yaml --wait 120s

      - name: Set kubeconfig
        run: |
          mkdir -p ~/.kube
          kind export kubeconfig --name kind
          kubectl cluster-info
          kubectl get nodes
          echo "KUBECONFIG content:"
          cat ~/.kube/config

      # ---------------------------
      # DEPLOY INFRA
      # ---------------------------
      - name: Deploy Postgres + Unleash
        run: |
          kubectl apply -f k8s/postgres.yaml
          kubectl apply -f k8s/unleash.yaml
          sleep 10  # Esperar a que los pods inicien
          kubectl wait --for=condition=ready pod -l app=postgres --timeout=60s || true
          kubectl wait --for=condition=available --timeout=180s deploy/unleash || true
          kubectl get pods -A

      - name: Load image into kind nodes
        run: |
          kind load docker-image ms-ejemplo:latest --name kind

      # ---------------------------
      # BLUE DEPLOY
      # ---------------------------
      - name: Deploy BLUE
        run: |
          kubectl apply -f k8s/deployment-blue.yaml
          kubectl apply -f k8s/service-selector-blue.yaml
          kubectl wait --for=condition=available --timeout=150s deploy/ms-ejemplo-blue
          kubectl get pods,svc

      - name: Run migrations
        continue-on-error: true
        run: |
          # Esperar a que Postgres esté listo
          sleep 15
          kubectl run migrate --restart=Never --image=ms-ejemplo:latest \
            --env="DATABASE_URL=postgres://postgres:password@postgres:5432/postgres" \
            -- /bin/sh -c "node migrate.js"
          sleep 10
          kubectl logs migrate
          kubectl delete pod migrate --force --grace-period=0 || true

      - name: Smoke tests (Preprod)
        run: |
          # Verificar que el servicio está disponible
          kubectl get svc ms-ejemplo
          # Usar port-forward en background
          kubectl port-forward svc/ms-ejemplo 30001:80 &
          PORT_FORWARD_PID=$!
          sleep 10  # Dar tiempo al port-forward
          echo "Port-forward PID: $PORT_FORWARD_PID"
          
          export BASE_URL=http://127.0.0.1:30001
          echo "Testing $BASE_URL"
          curl -v $BASE_URL/health || true
          
          node smoke-test.js
          
          # Matar el proceso de port-forward
          kill $PORT_FORWARD_PID

      # ---------------------------
      # GREEN CANARY
      # ---------------------------
      - name: Deploy GREEN (canary)
        run: |
          kubectl apply -f k8s/deployment-green.yaml
          kubectl scale deploy/ms-ejemplo-green --replicas=1
          kubectl wait --for=condition=available --timeout=60s deploy/ms-ejemplo-green

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg software-properties-common
          wget -q -O - https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install -y k6

      - name: Run k6 Canary Test
        run: |
          kubectl port-forward svc/ms-ejemplo 30001:80 &
          PORT_FORWARD_PID=$!
          sleep 10
          
          export BASE_URL=http://127.0.0.1:30001
          echo "Running k6 tests on $BASE_URL"
          
          # Primero verificar que el endpoint responde
          curl -s $BASE_URL/health
          
          k6 run --summary-export=summary.json --out json=results.json k6/loadtest.js || true
          
          kill $PORT_FORWARD_PID

      - name: Analyze k6
        id: decision
        continue-on-error: true
        run: |
          if [ -f "summary.json" ]; then
            node analyze_k6.js summary.json
            echo "PROMOTE=true" >> $GITHUB_OUTPUT
          else
            echo "No summary.json found, assuming failure"
            echo "PROMOTE=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ---------------------------
      # PROMOTE OR ROLLBACK
      # ---------------------------
      - name: Promote GREEN
        if: steps.decision.outputs.PROMOTE == 'true'
        run: |
          echo "Promoting GREEN deployment"
          kubectl patch service ms-ejemplo -p '{"spec":{"selector":{"app":"ms-ejemplo","version":"green"}}}'
          kubectl scale deploy/ms-ejemplo-green --replicas=3
          kubectl rollout status deploy/ms-ejemplo-green --timeout=150s
          kubectl get svc ms-ejemplo -o jsonpath='{.spec.selector}'

      - name: Rollback BLUE
        if: steps.decision.outputs.PROMOTE == 'false'
        run: |
          echo "Rolling back to BLUE deployment"
          kubectl patch service ms-ejemplo -p '{"spec":{"selector":{"app":"ms-ejemplo","version":"blue"}}}'
          kubectl scale deploy/ms-ejemplo-blue --replicas=3
          kubectl rollout status deploy/ms-ejemplo-blue --timeout=150s
          # Limpiar GREEN
          kubectl delete deploy/ms-ejemplo-green --ignore-not-found=true
          kubectl get svc ms-ejemplo -o jsonpath='{.spec.selector}'

      # ---------------------------
      # SAVE ARTIFACTS
      # ---------------------------
      - name: Save manifests and logs
        if: always()
        continue-on-error: true
        run: |
          kubectl get all -A -o wide > k8s-state.txt 2>&1 || true
          kubectl logs -l app=ms-ejemplo --tail=50 >> k8s-state.txt 2>&1 || true
          tar -czf artifacts.tar.gz k8s-state.txt

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cluster-artifacts
          path: artifacts.tar.gz
